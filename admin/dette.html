<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestion des Emprunts</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: '8px',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                        'button': '8px'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    
    <style>
        :where([class^="ri-"])::before { content: "\f3c2"; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-pending {
            background-color: #FEF3C7;
            color: #92400E;
        }
        .status-confirmed {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .status-paid {
            background-color: #DBEAFE;
            color: #1E40AF;
        }
        .table-row {
            transition: background-color 0.2s ease;
        }
        .table-row:hover {
            background-color: #f3f4f6;
        }
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4F46E5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Nav Bar -->
    <nav class="fixed top-0 w-full bg-white shadow-sm z-50">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center">
                <h1 class="text-xl font-['Pacifico'] text-primary">Orjeun Admin</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm font-medium text-primary">Chef de la Société</span>
               
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-20 pb-20 px-4 max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mt-4 mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Gestion des Emprunts des Vendeurs</h1>
            <p class="text-md text-gray-500">Surveillez et gérez tous les emprunts des vendeurs</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6 card">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-full mr-4">
                        <i class="ri-money-dollar-circle-line ri-2x text-primary"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total emprunts</p>
                        <h3 class="text-2xl font-bold" id="totalLoans">0 HTG</h3>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6 card">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-full mr-4">
                        <i class="ri-time-line ri-2x text-warning"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">En attente</p>
                        <h3 class="text-2xl font-bold" id="pendingLoans">0</h3>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6 card">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-full mr-4">
                        <i class="ri-check-line ri-2x text-secondary"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Remboursés</p>
                        <h3 class="text-2xl font-bold" id="paidLoans">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="pendingTab" class="px-4 py-2 font-medium text-primary border-b-2 border-primary">Demandes en attente</button>
            <button id="activeTab" class="px-4 py-2 font-medium text-gray-500">Emprunts actifs</button>
            <button id="paidTab" class="px-4 py-2 font-medium text-gray-500">Emprunts remboursés</button>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="py-8">
            <div class="loader"></div>
            <p class="text-center mt-4 text-gray-500">Chargement des données...</p>
        </div>

        <!-- Pending Requests Section -->
        <div id="pendingRequests" class="hidden">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendeur</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Département</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commune</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center py-8 hidden" id="noPendingMessage">
                <i class="ri-checkbox-circle-line ri-3x text-green-500 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-1">Aucune demande en attente</h3>
                <p class="text-gray-500">Toutes les demandes de crédit ont été traitées</p>
            </div>
        </div>

        <!-- Active Loans Section -->
        <div id="activeLoans" class="hidden">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendeur</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Département</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commune</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant dû</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date d'emprunt</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activeTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center py-8 hidden" id="noActiveMessage">
                <i class="ri-checkbox-circle-line ri-3x text-green-500 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-1">Aucun emprunt actif</h3>
                <p class="text-gray-500">Tous les emprunts ont été remboursés</p>
            </div>
        </div>

        <!-- Paid Loans Section -->
        <div id="paidLoansSection" class="hidden">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendeur</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date d'emprunt</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date de remboursement</th>
                            </tr>
                        </thead>
                        <tbody id="paidTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center py-8 hidden" id="noPaidMessage">
                <i class="ri-information-line ri-3x text-blue-500 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-1">Aucun emprunt remboursé</h3>
                <p class="text-gray-500">Les emprunts remboursés apparaîtront ici</p>
            </div>
        </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-medium text-gray-900 mb-3" id="modalTitle">Confirmer la demande</h3>
            <p class="text-sm text-gray-600 mb-4" id="modalMessage">Êtes-vous sûr de vouloir confirmer cette demande de crédit ?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelModalBtn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-button text-sm cursor-pointer">Annuler</button>
                <button id="confirmModalBtn" class="px-4 py-2 bg-primary text-white rounded-button text-sm cursor-pointer">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Paid Modal -->
    <div id="paidModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-medium text-gray-900 mb-3">Marquer comme payé</h3>
            <p class="text-sm text-gray-600 mb-4" id="paidModalMessage">Êtes-vous sûr de vouloir marquer cet emprunt comme payé ?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelPaidModalBtn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-button text-sm cursor-pointer">Annuler</button>
                <button id="confirmPaidModalBtn" class="px-4 py-2 bg-primary text-white rounded-button text-sm cursor-pointer">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300 hidden">
        <p id="toastMessage"></p>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuration Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDzo0khblPEzq28bS0ZuZmSMBqJm87WtNM",
                authDomain: "orjeun-9dec4.firebaseapp.com",
                databaseURL: "https://orjeun-9dec4-default-rtdb.firebaseio.com",
                projectId: "orjeun-9dec4",
                storageBucket: "orjeun-9dec4.appspot.com",
                messagingSenderId: "979782321937",
                appId: "1:979782321937:web:5b3971dba3240ae4b16eb0",
                measurementId: "G-G316HCYF9E"
            };

            // Initialisation Firebase
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();

            // Initialiser l'application sans vérification de connexion
            initializeApp();

            function initializeApp() {
                // UI Elements
                const pendingTab = document.getElementById('pendingTab');
                const activeTab = document.getElementById('activeTab');
                const paidTab = document.getElementById('paidTab');
                const pendingRequests = document.getElementById('pendingRequests');
                const activeLoans = document.getElementById('activeLoans');
                const paidLoansSection = document.getElementById('paidLoansSection');
                const pendingTableBody = document.getElementById('pendingTableBody');
                const activeTableBody = document.getElementById('activeTableBody');
                const paidTableBody = document.getElementById('paidTableBody');
                const noPendingMessage = document.getElementById('noPendingMessage');
                const noActiveMessage = document.getElementById('noActiveMessage');
                const noPaidMessage = document.getElementById('noPaidMessage');
                const totalLoans = document.getElementById('totalLoans');
                const pendingLoans = document.getElementById('pendingLoans');
                const paidLoans = document.getElementById('paidLoans');
                const loadingIndicator = document.getElementById('loadingIndicator');

                // Tabs functionality
                pendingTab.addEventListener('click', () => showTab('pending'));
                activeTab.addEventListener('click', () => showTab('active'));
                paidTab.addEventListener('click', () => showTab('paid'));

                function showTab(tab) {
                    pendingTab.classList.toggle('text-primary', tab === 'pending');
                    pendingTab.classList.toggle('border-b-2', tab === 'pending');
                    pendingTab.classList.toggle('border-primary', tab === 'pending');
                    pendingTab.classList.toggle('text-gray-500', tab !== 'pending');
                    
                    activeTab.classList.toggle('text-primary', tab === 'active');
                    activeTab.classList.toggle('border-b-2', tab === 'active');
                    activeTab.classList.toggle('border-primary', tab === 'active');
                    activeTab.classList.toggle('text-gray-500', tab !== 'active');
                    
                    paidTab.classList.toggle('text-primary', tab === 'paid');
                    paidTab.classList.toggle('border-b-2', tab === 'paid');
                    paidTab.classList.toggle('border-primary', tab === 'paid');
                    paidTab.classList.toggle('text-gray-500', tab !== 'paid');
                    
                    pendingRequests.classList.toggle('hidden', tab !== 'pending');
                    activeLoans.classList.toggle('hidden', tab !== 'active');
                    paidLoansSection.classList.toggle('hidden', tab !== 'paid');
                }

                // Chargement des données depuis Firebase
                let allCredits = [];
                let pendingCredits = [];
                let activeCredits = [];
                let paidCredits = [];
                
                // Écoute des changements dans la table 'crédit'
                database.ref('crédit').on('value', (snapshot) => {
                    allCredits = [];
                    pendingCredits = [];
                    activeCredits = [];
                    paidCredits = [];
                    
                    const credits = snapshot.val() || {};
                    
                    Object.keys(credits).forEach(key => {
                        const credit = credits[key];
                        credit.id = key;
                        allCredits.push(credit);
                        
                        if (credit.status === 'pending') {
                            pendingCredits.push(credit);
                        } else if (credit.status === 'confirmed') {
                            activeCredits.push(credit);
                        } else if (credit.status === 'paid') {
                            paidCredits.push(credit);
                        }
                    });
                    
                    updateStats();
                    renderTables();
                    
                    // Masquer l'indicateur de chargement
                    loadingIndicator.classList.add('hidden');
                });

                function updateStats() {
                    // Calcul des statistiques
                    let totalAmount = 0;
                    
                    allCredits.forEach(credit => {
                        if (credit.montant_emprunté) {
                            totalAmount += credit.montant_emprunté;
                        }
                    });
                    
                    totalLoans.textContent = totalAmount.toLocaleString('fr-FR') + ' HTG';
                    pendingLoans.textContent = pendingCredits.length;
                    paidLoans.textContent = paidCredits.length;
                }

                function renderTables() {
                    // Rendu des demandes en attente
                    renderPendingTable();
                    
                    // Rendu des emprunts actifs
                    renderActiveTable();
                    
                    // Rendu des emprunts remboursés
                    renderPaidTable();
                }

                function renderPendingTable() {
                    pendingTableBody.innerHTML = '';
                    
                    if (pendingCredits.length === 0) {
                        noPendingMessage.classList.remove('hidden');
                        return;
                    }
                    
                    noPendingMessage.classList.add('hidden');
                    
                    pendingCredits.forEach(credit => {
                        const regionParts = credit.region ? credit.region.split(',') : ['', ''];
                        const department = regionParts[0] ? regionParts[0].trim() : 'Non spécifié';
                        const commune = regionParts[1] ? regionParts[1].trim() : 'Non spécifié';
                        
                        const row = document.createElement('tr');
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium text-gray-900">${credit.Nom_vendeur || 'Non spécifié'}</div>
                                <div class="text-sm text-gray-500">${credit.Num_vendeur || ''}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${credit.name || 'Produit sans nom'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${department}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${commune}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${credit.nombre_emprunté || 0}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                ${(credit.montant_emprunté || 0).toLocaleString('fr-FR')} HTG
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${formatDate(credit.createdAt)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="confirm-btn mr-2 px-3 py-1 bg-primary text-white rounded-button text-sm" data-id="${credit.id}">
                                    Confirmer
                                </button>
                                <button class="reject-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-button text-sm" data-id="${credit.id}">
                                    Rejeter
                                </button>
                            </td>
                        `;
                        pendingTableBody.appendChild(row);
                    });
                }

                function renderActiveTable() {
                    activeTableBody.innerHTML = '';
                    
                    if (activeCredits.length === 0) {
                        noActiveMessage.classList.remove('hidden');
                        return;
                    }
                    
                    noActiveMessage.classList.add('hidden');
                    
                    activeCredits.forEach(credit => {
                        const regionParts = credit.region ? credit.region.split(',') : ['', ''];
                        const department = regionParts[0] ? regionParts[0].trim() : 'Non spécifié';
                        const commune = regionParts[1] ? regionParts[1].trim() : 'Non spécifié';
                        
                        const row = document.createElement('tr');
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium text-gray-900">${credit.Nom_vendeur || 'Non spécifié'}</div>
                                <div class="text-sm text-gray-500">${credit.Num_vendeur || ''}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${credit.name || 'Produit sans nom'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${department}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${commune}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                ${(credit.montant_emprunté || 0).toLocaleString('fr-FR')} HTG
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${formatDate(credit.createdAt)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="paid-btn px-3 py-1 bg-secondary text-white rounded-button text-sm" data-id="${credit.id}">
                                    Marquer comme payé
                                </button>
                            </td>
                        `;
                        activeTableBody.appendChild(row);
                    });
                }

                function renderPaidTable() {
                    paidTableBody.innerHTML = '';
                    
                    if (paidCredits.length === 0) {
                        noPaidMessage.classList.remove('hidden');
                        return;
                    }
                    
                    noPaidMessage.classList.add('hidden');
                    
                    paidCredits.forEach(credit => {
                        const paidDate = credit.paidDate ? formatDate(credit.paidDate) : 'Date inconnue';
                        
                        const row = document.createElement('tr');
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium text-gray-900">${credit.Nom_vendeur || 'Non spécifié'}</div>
                                <div class="text-sm text-gray-500">${credit.Num_vendeur || ''}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${credit.name || 'Produit sans nom'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                ${(credit.montant_emprunté || 0).toLocaleString('fr-FR')} HTG
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${formatDate(credit.createdAt)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${paidDate}
                            </td>
                        `;
                        paidTableBody.appendChild(row);
                    });
                }

                function formatDate(timestamp) {
                    if (!timestamp) return 'Date inconnue';
                    
                    const date = new Date(timestamp);
                    if (isNaN(date.getTime())) return 'Date invalide';
                    
                    return date.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                // Gestion des événements
                document.addEventListener('click', function(e) {
                    if (e.target.classList.contains('confirm-btn')) {
                        const creditId = e.target.dataset.id;
                        const credit = allCredits.find(c => c.id === creditId);
                        
                        if (credit) {
                            showConfirmModal('Confirmer la demande', 
                                `Confirmer la demande de ${credit.Nom_vendeur} pour ${credit.name} ?`, 
                                () => confirmCreditRequest(creditId)
                            );
                        }
                    }
                    
                    if (e.target.classList.contains('paid-btn')) {
                        const creditId = e.target.dataset.id;
                        const credit = allCredits.find(c => c.id === creditId);
                        
                        if (credit) {
                            showPaidModal('Marquer comme payé', 
                                `Marquer l'emprunt de ${credit.Nom_vendeur} pour ${credit.name} comme payé ?`, 
                                () => markCreditAsPaid(creditId)
                            );
                        }
                    }
                    
                    if (e.target.classList.contains('reject-btn')) {
                        const creditId = e.target.dataset.id;
                        const credit = allCredits.find(c => c.id === creditId);
                        
                        if (credit) {
                            showConfirmModal('Rejeter la demande', 
                                `Rejeter la demande de ${credit.Nom_vendeur} pour ${credit.name} ?`, 
                                () => rejectCreditRequest(creditId)
                            );
                        }
                    }
                });
                
                // Fonctions de gestion des crédits
                function confirmCreditRequest(creditId) {
                    database.ref(`crédit/${creditId}`).update({
                        status: 'confirmed'
                    })
                    .then(() => {
                        showToast('Demande confirmée avec succès');
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showToast(`Échec de la confirmation: ${error.message}`);
                    });
                }
                
                function markCreditAsPaid(creditId) {
                    const paidDate = firebase.database.ServerValue.TIMESTAMP;
                    
                    database.ref(`crédit/${creditId}`).update({
                        status: 'paid',
                        paidDate: paidDate
                    })
                    .then(() => {
                        showToast('Emprunt marqué comme payé');
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showToast(`Échec de l'opération: ${error.message}`);
                    });
                }
                
                function rejectCreditRequest(creditId) {
                    database.ref(`crédit/${creditId}`).remove()
                    .then(() => {
                        showToast('Demande rejetée');
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        showToast(`Échec du rejet: ${error.message}`);
                    });
                }
                
                // Modal functions
                function showConfirmModal(title, message, onConfirm) {
                    const modal = document.getElementById('confirmModal');
                    modal.querySelector('#modalTitle').textContent = title;
                    modal.querySelector('#modalMessage').textContent = message;
                    modal.classList.remove('hidden');
                    
                    const confirmHandler = () => {
                        modal.classList.add('hidden');
                        onConfirm();
                        document.getElementById('confirmModalBtn').removeEventListener('click', confirmHandler);
                        document.getElementById('cancelModalBtn').removeEventListener('click', cancelHandler);
                    };
                    
                    const cancelHandler = () => {
                        modal.classList.add('hidden');
                        document.getElementById('confirmModalBtn').removeEventListener('click', confirmHandler);
                        document.getElementById('cancelModalBtn').removeEventListener('click', cancelHandler);
                    };
                    
                    document.getElementById('confirmModalBtn').addEventListener('click', confirmHandler);
                    document.getElementById('cancelModalBtn').addEventListener('click', cancelHandler);
                }
                
                function showPaidModal(title, message, onConfirm) {
                    const modal = document.getElementById('paidModal');
                    modal.querySelector('#paidModalMessage').textContent = message;
                    modal.classList.remove('hidden');
                    
                    const confirmHandler = () => {
                        modal.classList.add('hidden');
                        onConfirm();
                        document.getElementById('confirmPaidModalBtn').removeEventListener('click', confirmHandler);
                        document.getElementById('cancelPaidModalBtn').removeEventListener('click', cancelHandler);
                    };
                    
                    const cancelHandler = () => {
                        modal.classList.add('hidden');
                        document.getElementById('confirmPaidModalBtn').removeEventListener('click', confirmHandler);
                        document.getElementById('cancelPaidModalBtn').removeEventListener('click', cancelHandler);
                    };
                    
                    document.getElementById('confirmPaidModalBtn').addEventListener('click', confirmHandler);
                    document.getElementById('cancelPaidModalBtn').addEventListener('click', cancelHandler);
                }
                
                // Toast function
                window.showToast = (message, duration = 3000) => {
                    const toast = document.getElementById('toast');
                    toast.querySelector('#toastMessage').textContent = message;
                    toast.classList.remove('hidden');
                    toast.style.opacity = '1';
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => toast.classList.add('hidden'), 300);
                    }, duration);
                };
                
                // Initial render
                showTab('pending');
                pendingRequests.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>