<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">    
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statistiques des Formations - FormaPro</title>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>tailwind.config={theme:{extend:{colors:{primary:'#4F46E5',secondary:'#8B5CF6',tertiary:'#0EA5E9'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
<style>
:where([class^="ri-"])::before { content: "\f3c2"; }
body {
  font-family: 'Inter', sans-serif;
  background-color: #f9fafb;
}
.nav-link {
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: 500;
  transition: all 0.3s ease;
}
.nav-link:hover {
  background-color: #f1f5f9;
}
.nav-link.active {
  background-color: #4F46E5;
  color: white;
}
.notification {
  transform: translateY(-10px);
  opacity: 0;
  transition: all 0.3s ease;
}
.notification.show {
  transform: translateY(0);
  opacity: 1;
}
.card-stat {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  overflow: hidden;
}
.card-stat:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}
.stat-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}
.stat-value {
  font-size: 2.25rem;
  font-weight: 700;
}
.stat-title {
  color: #6b7280;
  font-size: 0.875rem;
}
.chart-container {
  height: 300px;
}
.page-section {
  display: none;
}
.page-section.active {
  display: block;
}
.progress-bar {
  height: 8px;
  border-radius: 4px;
  background-color: #e5e7eb;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  border-radius: 4px;
}
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.loading-spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(79, 70, 229, 0.3);
  border-radius: 50%;
  border-top-color: #4F46E5;
  animation: spin 1s ease-in-out infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body class="min-h-screen pt-16 pb-24">
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<!-- Navigation Bar -->
<nav class="fixed top-0 left-0 w-full bg-white shadow-sm z-10">
  <div class="px-4 py-3 flex items-center justify-between">
    <div class="flex items-center">
      <span class="text-xl font-['Pacifico'] text-primary">FormaPro</span>
    </div>
    <div class="flex items-center space-x-6">
      <a href="#" class="nav-link" data-page="creer">Créer</a>
      <a href="#" class="nav-link active" data-page="stat">Statistiques</a>
      <a href="#" class="nav-link" data-page="rapport">Rapport</a>
    </div>
    <div class="flex items-center space-x-2">
      <div class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100">
        <i class="ri-user-line text-gray-600"></i>
      </div>
    </div>
  </div>
</nav>

<div class="container mx-auto px-4 pt-8 pb-24">
  <!-- Page Statistiques (active par défaut) -->
  <div id="page-stat" class="page-section active">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-gray-800">Statistiques des Formations</h1>
      <p class="text-gray-600 mt-1">Analysez les performances de vos formations</p>
      <div class="h-1 w-20 bg-primary mt-3 rounded-full"></div>
    </div>
    
    <!-- Informations du professeur -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
      <div class="flex flex-col md:flex-row md:items-center justify-between">
        <div class="flex items-center mb-4 md:mb-0">
          <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mr-4">
            <i class="ri-user-3-line text-2xl text-primary"></i>
          </div>
          <div>
            <h2 class="text-xl font-bold text-gray-800" id="professor-name">Chargement...</h2>
            <p class="text-gray-600" id="professor-email">email@exemple.com</p>
          </div>
        </div>
        <div class="flex space-x-4">
          <div class="text-center">
            <p class="text-2xl font-bold text-primary" id="total-formations">0</p>
            <p class="text-sm text-gray-600">Formations</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-secondary" id="total-participants">0</p>
            <p class="text-sm text-gray-600">Participants</p>
          </div>
          <div class="text-center">
            <p class="text-2xl font-bold text-tertiary" id="completion-rate">0%</p>
            <p class="text-sm text-gray-600">Taux de complétion</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Statistiques principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="card-stat p-6">
        <div class="flex items-center">
          <div class="stat-icon bg-blue-100 text-blue-600 mr-4">
            <i class="ri-stack-line"></i>
          </div>
          <div>
            <p class="stat-value text-blue-600" id="stat-online">0</p>
            <p class="stat-title">Formations en ligne</p>
          </div>
        </div>
      </div>
      
      <div class="card-stat p-6">
        <div class="flex items-center">
          <div class="stat-icon bg-purple-100 text-purple-600 mr-4">
            <i class="ri-building-line"></i>
          </div>
          <div>
            <p class="stat-value text-purple-600" id="stat-professional">0</p>
            <p class="stat-title">Formations professionnelles</p>
          </div>
        </div>
      </div>
      
      <div class="card-stat p-6">
        <div class="flex items-center">
          <div class="stat-icon bg-green-100 text-green-600 mr-4">
            <i class="ri-checkbox-circle-line"></i>
          </div>
          <div>
            <p class="stat-value text-green-600" id="stat-completed">0</p>
            <p class="stat-title">Formations complétées</p>
          </div>
        </div>
      </div>
      
      <div class="card-stat p-6">
        <div class="flex items-center">
          <div class="stat-icon bg-red-100 text-red-600 mr-4">
            <i class="ri-close-circle-line"></i>
          </div>
          <div>
            <p class="stat-value text-red-600" id="stat-cancelled">0</p>
            <p class="stat-title">Formations annulées</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Graphiques -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">Répartition par type</h3>
        <div class="chart-container flex items-center justify-center">
          <canvas id="typeChart"></canvas>
        </div>
      </div>
      
      <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">Taux de complétion</h3>
        <div class="space-y-4">
          <div>
            <div class="flex justify-between mb-1">
              <span class="text-sm font-medium text-gray-700">Formation en ligne</span>
              <span class="text-sm font-medium text-gray-700" id="online-completion">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill bg-blue-600" id="online-progress" style="width: 0%"></div>
            </div>
          </div>
          
          <div>
            <div class="flex justify-between mb-1">
              <span class="text-sm font-medium text-gray-700">Formation professionnelle</span>
              <span class="text-sm font-medium text-gray-700" id="pro-completion">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill bg-purple-600" id="pro-progress" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Formations récentes -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-semibold text-gray-800">Formations récentes</h3>
        <button class="px-3 py-1.5 bg-gray-50 text-gray-600 rounded-button text-sm font-medium hover:bg-gray-100 !rounded-button">
          Voir tout
        </button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Formation</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Participants</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            </tr>
          </thead>
          <tbody id="recent-formations" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="5" class="text-center py-6 text-gray-500">
                <i class="ri-loader-4-line animate-spin text-xl mr-2"></i>
                Chargement des formations...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Page Créer de formation -->
  <div id="page-creer" class="page-section">
    <!-- Le contenu de la page de création ira ici -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-10 text-center py-16">
      <div class="max-w-md mx-auto">
        <div class="w-20 h-20 mx-auto rounded-full bg-blue-100 flex items-center justify-center mb-6">
          <i class="ri-add-line text-3xl text-blue-600"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-800 mb-2">Page de création de formation</h2>
        <p class="text-gray-600 mb-6">Cette page permet de créer de nouvelles formations en ligne ou professionnelles.</p>
        <button id="createFormationBtn" class="px-6 py-3 bg-primary text-white rounded-button font-medium hover:bg-primary/90 transition-colors">
          Créer une nouvelle formation
        </button>
      </div>
    </div>
  </div>
  
  <!-- Page Rapport de formation -->
  <div id="page-rapport" class="page-section">
    <!-- Le contenu de la page de rapport ira ici -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-10 text-center py-16">
      <div class="max-w-md mx-auto">
        <div class="w-20 h-20 mx-auto rounded-full bg-green-100 flex items-center justify-center mb-6">
          <i class="ri-file-chart-line text-3xl text-green-600"></i>
        </div>
        <h2 class="text-xl font-bold text-gray-800 mb-2">Page de rapport de formation</h2>
        <p class="text-gray-600 mb-6">Cette page présente des rapports détaillés sur les formations.</p>
        <button id="rapbtn"class="px-6 py-3 bg-green-600 text-white rounded-button font-medium hover:bg-green-700 transition-colors">
          Générer un rapport
        </button>
      </div>
    </div>
  </div>
  
  <!-- Notification -->
  <div id="notification" class="notification mt-4 py-3 px-4 rounded-md hidden">
    <div class="flex items-center">
      <i id="notificationIcon" class="mr-2"></i>
      <span id="notificationMessage"></span>
    </div>
  </div>
</div>

<!-- Scripts Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Configuration Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDzo0khblPEzq28bS0ZuZmSMBqJm87WtNM",
    authDomain: "orjeun-9dec4.firebaseapp.com",
    databaseURL: "https://orjeun-9dec4-default-rtdb.firebaseio.com",
    projectId: "orjeun-9dec4",
    storageBucket: "orjeun-9dec4.appspot.com",
    messagingSenderId: "979782321937",
    appId: "1:979782321937:web:5b3971dba3240ae4b16eb0",
    measurementId: "G-G316HCYF9E"
  };

  // Initialisation Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const database = firebase.database();
  
  // Récupération des informations de connexion depuis le sessionStorage
  const userEmail = sessionStorage.getItem('userEmail');
  
  // Vérification de la présence de l'email
  if (!userEmail) {
    window.location.href = "login.html";
    return;
  }
  
  // Affichage initial des informations du professeur
  document.getElementById('professor-email').textContent = userEmail;
  
  // Navigation entre les pages
  const navLinks = document.querySelectorAll('.nav-link');
  const pageSections = document.querySelectorAll('.page-section');
  
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Retirer la classe active de tous les liens
      navLinks.forEach(l => l.classList.remove('active'));
      
      // Ajouter la classe active au lien cliqué
      this.classList.add('active');
      
      // Masquer toutes les sections
      pageSections.forEach(section => section.classList.remove('active'));
      
      // Afficher la section correspondante
      const targetPage = this.getAttribute('data-page');
      document.getElementById(`page-${targetPage}`).classList.add('active');
    });
  });
  
  // Gestion du bouton de création de formation
  document.getElementById('createFormationBtn').addEventListener('click', function() {
    window.location.href = 'Formation.html';
  });
  
  // Gestion du bouton de création de rapport
  document.getElementById('rapbtn').addEventListener('click', function() {
    window.location.href = 'rapport.html';
  });
  
  // Fonction pour formater la date
  function formatDate(dateString) {
    if (!dateString) return 'Date non définie';
    const date = new Date(dateString);
    return date.toLocaleDateString('fr-FR');
  }
  
  // Fonction pour afficher une notification
  function showNotification(message, type) {
    const notification = document.getElementById('notification');
    const notificationIcon = document.getElementById('notificationIcon');
    const notificationMessage = document.getElementById('notificationMessage');
    
    notification.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
    notificationIcon.classList.remove('ri-check-line', 'ri-error-warning-line', 'text-green-500', 'text-red-500');
    
    if (type === 'success') {
      notification.classList.add('bg-green-100');
      notificationIcon.classList.add('ri-check-line', 'text-green-500');
    } else {
      notification.classList.add('bg-red-100');
      notificationIcon.classList.add('ri-error-warning-line', 'text-red-500');
    }
    
    notificationMessage.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.classList.add('hidden'), 300);
    }, 3000);
  }
  
  // Fonction pour calculer les statistiques
  function calculateStats(formations) {
    const stats = {
      online: 0,
      professional: 0,
      completed: 0,
      cancelled: 0,
      totalParticipants: 0,
      onlineCompletion: 0,
      proCompletion: 0,
      completionRate: 0
    };
    
    // Calcul des statistiques de base
    formations.forEach(formation => {
      if (formation.type_formation === "En ligne") {
        stats.online++;
        if (formation.statut === "Terminé") {
          stats.onlineCompletion++;
        }
      } else if (formation.type_formation === "Professionnelle") {
        stats.professional++;
        if (formation.statut === "Terminé") {
          stats.proCompletion++;
        }
      }
      
      if (formation.statut === "Terminé") stats.completed++;
      if (formation.statut === "Annulé") stats.cancelled++;
      
      // Ajout des participants
      if (formation.participants) {
        stats.totalParticipants += formation.participants;
      }
    });
    
    // Calcul des taux
    if (stats.online > 0) {
      stats.onlineCompletion = Math.round((stats.onlineCompletion / stats.online) * 100);
    }
    
    if (stats.professional > 0) {
      stats.proCompletion = Math.round((stats.proCompletion / stats.professional) * 100);
    }
    
    const totalActiveFormations = formations.filter(f => 
      f.statut === "Terminé" || f.statut === "En cours"
    ).length;
    
    if (totalActiveFormations > 0) {
      stats.completionRate = Math.round((stats.completed / totalActiveFormations) * 100);
    }
    
    return stats;
  }
  
  // Fonction pour afficher les formations dans le tableau
  function displayFormations(formations) {
    const recentFormations = document.getElementById('recent-formations');
    recentFormations.innerHTML = '';
    
    if (formations.length === 0) {
      recentFormations.innerHTML = `
        <tr>
          <td colspan="5" class="text-center py-6 text-gray-500">
            Aucune formation trouvée
          </td>
        </tr>
      `;
      return;
    }
    
    // Prendre les 5 formations les plus récentes
    const recent = formations.slice(0, 5);
    
    recent.forEach(formation => {
      // Déterminer la couleur en fonction du statut
      let statusColor = '';
      if (formation.statut === "Terminé") statusColor = 'bg-green-100 text-green-800';
      else if (formation.statut === "En cours") statusColor = 'bg-blue-100 text-blue-800';
      else if (formation.statut === "À venir") statusColor = 'bg-yellow-100 text-yellow-800';
      else statusColor = 'bg-gray-100 text-gray-800';
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-4 py-3 whitespace-nowrap">
          <div class="font-medium text-gray-900">${formation.nom_formation || 'Nom non défini'}</div>
        </td>
        <td class="px-4 py-3 whitespace-nowrap">
          <span class="px-2 py-1 text-xs rounded-full ${formation.type_formation === "En ligne" ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800'}">
            ${formation.type_formation || 'Type non défini'}
          </span>
        </td>
        <td class="px-4 py-3 whitespace-nowrap text-gray-600">${formatDate(formation.date_formation)}</td>
        <td class="px-4 py-3 whitespace-nowrap">
          <div class="flex items-center">
            <i class="ri-user-line mr-1 text-gray-500"></i>
            <span>${formation.participants || 0}</span>
          </div>
        </td>
        <td class="px-4 py-3 whitespace-nowrap">
          <span class="px-2 py-1 text-xs rounded-full ${statusColor}">
            ${formation.statut || 'Statut non défini'}
          </span>
        </td>
      `;
      recentFormations.appendChild(row);
    });
  }
  
  // Fonction pour créer ou mettre à jour le graphique circulaire
  let typeChart = null;
  function updateTypeChart(onlineCount, professionalCount) {
    const typeCtx = document.getElementById('typeChart').getContext('2d');
    
    // Détruire le graphique précédent s'il existe
    if (typeChart) {
      typeChart.destroy();
    }
    
    typeChart = new Chart(typeCtx, {
      type: 'doughnut',
      data: {
        labels: ['En ligne', 'Professionnelle'],
        datasets: [{
          data: [onlineCount, professionalCount],
          backgroundColor: ['#4F46E5', '#8B5CF6'],
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 15,
              padding: 20,
              font: {
                size: 13
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.raw || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = Math.round((value / total) * 100);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        },
        cutout: '70%'
      }
    });
  }
  
  // Fonction pour mettre à jour l'interface avec les statistiques
  function updateUIStats(stats, formations) {
    document.getElementById('stat-online').textContent = stats.online;
    document.getElementById('stat-professional').textContent = stats.professional;
    document.getElementById('stat-completed').textContent = stats.completed;
    document.getElementById('stat-cancelled').textContent = stats.cancelled;
    document.getElementById('total-formations').textContent = formations.length;
    document.getElementById('total-participants').textContent = stats.totalParticipants;
    document.getElementById('completion-rate').textContent = `${stats.completionRate}%`;
    document.getElementById('online-completion').textContent = `${stats.onlineCompletion}%`;
    document.getElementById('pro-completion').textContent = `${stats.proCompletion}%`;
    
    // Animation des barres de progression
    setTimeout(() => {
      document.getElementById('online-progress').style.width = `${stats.onlineCompletion}%`;
      document.getElementById('pro-progress').style.width = `${stats.proCompletion}%`;
    }, 300);
    
    // Mettre à jour le tableau des formations
    displayFormations(formations);
    
    // Créer ou mettre à jour le graphique circulaire
    updateTypeChart(stats.online, stats.professional);
  }
  
  // Fonction pour charger les données du professeur et ses formations
  async function loadProfessorData() {
    try {
      // Récupérer le professeur depuis confirm_membres dans RTDB
      const confirmedMembersRef = database.ref('confirmed_adm_member');
      const confirmedMembersSnapshot = await confirmedMembersRef.once('value');
      const confirmedMembers = confirmedMembersSnapshot.val();
      
      let professorFormations = [];
      let professorName = "Professeur";
      let professorFound = false;
      
      // Parcourir les membres pour trouver le professeur
      for (const key in confirmedMembers) {
        const member = confirmedMembers[key];
        if (member.email === userEmail) {
          professorFound = true;
          professorName = member.nom || member.email.split('@')[0];
          break;
        }
      }
      
      if (!professorFound) {
        showNotification("Utilisateur non trouvé. Redirection vers la page de connexion...", "error");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 2000);
        return;
      }
      
      // Récupérer les formations depuis RTDB
      const formationsRef = database.ref('formations');
      const formationsSnapshot = await formationsRef.once('value');
      const allFormations = formationsSnapshot.val();
      
      // Filtrer les formations pour ce professeur
      for (const key in allFormations) {
        if (allFormations[key].prof === userEmail) {
          professorFormations.push({
            id: key,
            ...allFormations[key]
          });
        }
      }
      
      // Trier les formations par date (les plus récentes d'abord)
      professorFormations.sort((a, b) => {
        const dateA = a.date_formation ? new Date(a.date_formation) : new Date(0);
        const dateB = b.date_formation ? new Date(b.date_formation) : new Date(0);
        return dateB - dateA;
      });
      
      // Mettre à jour le nom du professeur
      document.getElementById('professor-name').textContent = professorName;
      
      // Calculer les statistiques
      const stats = calculateStats(professorFormations);
      
      // Mettre à jour l'interface
      updateUIStats(stats, professorFormations);
      
    } catch (error) {
      console.error("Erreur lors du chargement des données:", error);
      showNotification("Erreur lors du chargement des données", "error");
      
      // Mettre à jour le tableau avec un message d'erreur
      const recentFormations = document.getElementById('recent-formations');
      recentFormations.innerHTML = `
        <tr>
          <td colspan="5" class="text-center py-6 text-gray-500">
            Erreur de chargement des données
          </td>
        </tr>
      `;
    } finally {
      // Cacher l'overlay de chargement dans tous les cas
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  }
  
  // Charger les données au démarrage
  loadProfessorData();
});
</script>
</body>
</html>