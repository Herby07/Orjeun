)<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Produits</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: '8px',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                        'button': '8px'
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    
    <style>
        :where([class^="ri-"])::before { content: "\f3c2"; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .product-card {
            transition: transform 0.2s ease;
        }
        .product-card:hover {
            transform: translateY(-2px);
        }
        .image-preview {
            width: 100%;
            height: 150px; /* Hauteur réduite */
            object-fit: contain; /* Affiche l'image complète sans découpe */
            background-color: #f8fafc; /* Fond pour les images transparentes */
            padding: 5px;
        }
        .upload-container {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-container:hover {
            border-color: #4F46E5;
            background: #f0f4ff;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Nav Bar -->
    <nav class="fixed top-0 w-full bg-white shadow-sm z-50">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center">
                <h1 class="text-xl font-['Pacifico'] text-primary">Orjeun</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="userNameNav" class="text-sm font-medium text-primary"></span>
                <div class="w-8 h-8 flex items-center justify-center">
                    <i class="ri-notification-3-line ri-lg text-gray-600"></i>
                </div>
                <div class="w-8 h-8 flex items-center justify-center">
                    <i class="ri-settings-3-line ri-lg text-gray-600"></i>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-16 pb-20 px-4">
        <!-- Header -->
        <div class="mt-4 mb-6">
            <h1 class="text-2xl font-semibold text-gray-800">Gestion des Produits</h1>
            <p class="text-sm text-gray-500">Ajoutez et gérez vos produits sur la marketplace</p>
        </div>

        <!-- Add Product Button -->
        <button id="addProductBtn" class="mb-6 bg-primary text-white px-4 py-2 rounded-button flex items-center justify-center w-full cursor-pointer">
            <i class="ri-add-line ri-lg mr-2"></i>
            <span>Ajouter un Produit</span>
        </button>

        <!-- Add Product Form -->
        <div id="productForm" class="bg-white rounded-lg shadow-sm p-4 mb-6 hidden">
            <h2 class="text-lg font-medium text-gray-800 mb-4">Nouveau Produit</h2>
            
            <form id="newProductForm">
                <!-- Image Upload -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image du produit</label>
                    <div class="upload-container" onclick="document.getElementById('fileInput').click()">
                        <i class="ri-upload-cloud-2-line text-4xl text-primary mb-2"></i>
                        <p class="font-medium">Cliquer pour sélectionner une image</p>
                        <p class="text-sm text-gray-500 mt-1">JPG/PNG - Max 5MB</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" hidden>
                    <div id="uploadStatus" class="hidden mt-4 text-center text-sm text-gray-500">
                        <i class="ri-loader-4-line animate-spin mr-2"></i>Téléchargement en cours...
                    </div>
                    <img id="imagePreview" class="hidden mx-auto image-preview rounded-lg mt-4" alt="Aperçu de l'image">
                </div>
                
                <!-- Product Name -->
                <div class="mb-4">
                    <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Nom du produit</label>
                    <input type="text" id="productName" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm" placeholder="Ex: Chemise en lin" required>
                </div>

                <!-- Price -->
                <div class="mb-4">
                    <label for="productPrice" class="block text-sm font-medium text-gray-700 mb-1">Prix (HTG)</label> <!-- Devise changée -->
                    <input type="number" id="productPrice" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm" placeholder="Ex: 15000" required>
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <label for="productDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="productDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm" placeholder="Décrivez votre produit..." required></textarea>
                </div>

                <!-- Region -->
                <div class="mb-4">
                    <label for="productRegion" class="block text-sm font-medium text-gray-700 mb-1">Région disponible</label>
                    <input type="text" id="productRegion" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm" placeholder="Ex: Abidjan, Yamoussoukro" required>
                </div>

                <!-- Emprunt Checkbox -->
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="empruntCheckbox" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Je veux faire un emprunt pour ce produit</span>
                    </label>
                </div>

                <!-- Emprunt Fields (Hidden by default) -->
                <div id="empruntFields" class="hidden mb-4">
                    <div class="mb-2">
                        <label for="nombreEmprunte" class="block text-sm font-medium text-gray-700 mb-1">Nombre de produits à emprunter</label>
                        <input type="number" id="nombreEmprunte" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm" placeholder="Ex: 5">
                    </div>
                    <p id="coutEmprunt" class="text-sm text-gray-600">Veuillez entrer le prix pour voir le montant du prêt.</p>
                </div>

                <!-- Quantity -->
                <div class="mb-4" id="quantityField">
                    <label for="productQuantity" class="block text-sm font-medium text-gray-700 mb-1">Quantité disponible</label>
                    <input type="number" id="productQuantity" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-button text-sm" placeholder="Ex: 10" required>
                </div>

                <!-- WhatsApp Number -->
                <div class="mb-4">
                    <label for="whatsappNumber" class="block text-sm font-medium text-gray-700 mb-1">Numéro WhatsApp</label>
                    <div class="flex items-center">
                        <span class="px-3 py-2 bg-gray-100 border border-r-0 border-gray-300 rounded-l-button text-sm">+509</span>
                        <input type="tel" id="whatsappNumber" class="flex-1 px-3 py-2 border border-gray-300 rounded-r-button text-sm" placeholder="Ex: 34 56 78 90" pattern="[0-9]{8,10}" required>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3">
                    <button type="button" id="cancelProductBtn" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-button text-sm cursor-pointer">Annuler</button>
                    <button type="submit" id="saveProductBtn" class="flex-1 px-4 py-2 bg-primary text-white rounded-button text-sm cursor-pointer">Enregistrer</button>
                </div>
            </form>
        </div>

        <!-- Pending Credit Products Section -->
        <div id="pendingCreditSection" class="mb-6 hidden">
            <h2 class="text-lg font-medium text-gray-800 mb-3">Produits en attente de confirmation</h2>
            <div id="pendingCreditProducts" class="space-y-3"></div>
        </div>

        <!-- Active Products Section -->
        <div class="mb-6">
            <h2 class="text-lg font-medium text-gray-800 mb-3">Produits Actifs</h2>
            <div id="activeProducts" class="space-y-3"></div>
        </div>

        <!-- Product History Section -->
        <div>
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-medium text-gray-800">Historique des Produits</h2>
                <button id="toggleHistoryBtn" class="text-xs text-primary flex items-center cursor-pointer">
                    <span>Voir tout</span>
                    <div class="w-4 h-4 flex items-center justify-center ml-1">
                        <i class="ri-arrow-down-s-line"></i>
                    </div>
                </button>
            </div>
            
            <div id="productHistory" class="space-y-3 hidden"></div>
        </div>
    </main>

    <!-- Tab Bar -->
    <!-- Tab Bar -->
<div class="fixed bottom-0 w-full bg-white border-t border-gray-200 px-2 py-1 grid grid-cols-3">
    <a href="product.html" class="flex flex-col items-center justify-center py-1 text-primary cursor-pointer">
        <div class="w-6 h-6 flex items-center justify-center">
            <i class="ri-store-2-fill ri-lg"></i>
        </div>
        <span class="text-xs mt-1">Produits</span>
    </a>
    <a href="stat.html" class="flex flex-col items-center justify-center py-1 text-gray-500 cursor-pointer">
        <div class="w-6 h-6 flex items-center justify-center">
            <i class="ri-line-chart-line ri-lg"></i>
        </div>
        <span class="text-xs mt-1">Statistiques</span>
    </a>
    <a href="profil.html" class="flex flex-col items-center justify-center py-1 text-gray-500 cursor-pointer">
        <div class="w-6 h-6 flex items-center justify-center">
            <i class="ri-user-line ri-lg"></i>
        </div>
        <span class="text-xs mt-1">Profil</span>
    </a>
</div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300 hidden">
        <p id="toastMessage"></p>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-5 w-4/5 max-w-sm">
            <h3 class="text-lg font-medium text-gray-900 mb-3" id="modalTitle">Confirmer la vente</h3>
            <p class="text-sm text-gray-600 mb-4" id="modalMessage">Êtes-vous sûr de vouloir enregistrer cette vente ?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelModalBtn" class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded-button text-sm cursor-pointer">Annuler</button>
                <button id="confirmModalBtn" class="px-3 py-1.5 bg-primary text-white rounded-button text-sm cursor-pointer">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const UPLOADCARE_PUB_KEY = 'ffd4bffb1936c80f5abd';
            let uploadedFileUrl = null;
            let saveButtonOriginalHTML = ''; // Stocker le contenu original du bouton

            // Gestion de l'upload
            document.getElementById('fileInput').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    showToast("Le fichier est trop volumineux (max 5MB)");
                    return;
                }

                document.getElementById('uploadStatus').classList.remove('hidden');
                document.getElementById('imagePreview').classList.add('hidden');

                try {
                    const formData = new FormData();
                    formData.append('UPLOADCARE_PUB_KEY', UPLOADCARE_PUB_KEY);
                    formData.append('file', file);

                    const response = await fetch('https://upload.uploadcare.com/base/', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    
                    if (data.file) {
                        uploadedFileUrl = `https://ucarecdn.com/${data.file}/`;
                        document.getElementById('imagePreview').src = uploadedFileUrl;
                        document.getElementById('imagePreview').classList.remove('hidden');
                    } else {
                        throw new Error('Réponse API invalide');
                    }

                } catch (error) {
                    console.error("Erreur d'upload:", error);
                    showToast("Échec de l'upload de l'image");
                } finally {
                    document.getElementById('uploadStatus').classList.add('hidden');
                }
            });

            // Authentification
            const userEmail = sessionStorage.getItem('userEmail');
            const userPassword = sessionStorage.getItem('userPassword');
            
            if (!userEmail || !userPassword) {
                window.location.href = 'login.html';
                return;
            }

            // Configuration Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDzo0khblPEzq28bS0ZuZmSMBqJm87WtNM",
                authDomain: "orjeun-9dec4.firebaseapp.com",
                databaseURL: "https://orjeun-9dec4-default-rtdb.firebaseio.com",
                projectId: "orjeun-9dec4",
                storageBucket: "orjeun-9dec4.appspot.com",
                messagingSenderId: "979782321937",
                appId: "1:979782321937:web:5b3971dba3240ae4b16eb0",
                measurementId: "G-G316HCYF9E"
            };

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();

            // Vérification utilisateur
            database.ref('confirmed_adm_member').once('value').then(snapshot => {
                const users = snapshot.val();
                let userFound = null;

                for (const key in users) {
                    const user = users[key];
                    if (user.email === userEmail && user.password === userPassword) {
                        userFound = user;
                        break;
                    }
                }

                if (userFound) {
                    document.getElementById('userNameNav').textContent = userFound.nom;
                    sessionStorage.setItem('userName', userFound.nom);
                    localStorage.setItem('userRole', userFound.role);
                    initializeApp();
                } else {
                    window.location.href = 'login.html';
                }
            }).catch(error => {
                console.error("Erreur de recherche:", error);
                window.location.href = 'login.html';
            });

            function initializeApp() {
                let currentProducts = [];
                let isUploading = false;
                const currentUserName = sessionStorage.getItem('userName');
                const saveButton = document.getElementById('saveProductBtn');
                saveButtonOriginalHTML = saveButton.innerHTML; // Stocker le contenu original

                // Éléments UI
                const addProductBtn = document.getElementById('addProductBtn');
                const productForm = document.getElementById('productForm');
                const cancelProductBtn = document.getElementById('cancelProductBtn');
                const empruntCheckbox = document.getElementById('empruntCheckbox');
                const empruntFields = document.getElementById('empruntFields');
                const nombreEmprunteInput = document.getElementById('nombreEmprunte');
                const coutEmpruntElement = document.getElementById('coutEmprunt');
                const productPriceInput = document.getElementById('productPrice');
                const quantityField = document.getElementById('quantityField');
                const quantityInput = document.getElementById('productQuantity');

                // Gestion du formulaire
                addProductBtn.addEventListener('click', () => toggleForm(true));
                cancelProductBtn.addEventListener('click', () => toggleForm(false));

                // Gestion de l'emprunt
                empruntCheckbox.addEventListener('change', function() {
                    empruntFields.classList.toggle('hidden', !this.checked);
                    quantityField.classList.toggle('hidden', this.checked);
                    
                    // CORRECTION: Supprimer l'attribut required quand le champ est caché
                    if (this.checked) {
                        quantityInput.removeAttribute('required');
                        updateCoutEmprunt();
                    } else {
                        quantityInput.setAttribute('required', 'true');
                    }
                });

                nombreEmprunteInput.addEventListener('input', updateCoutEmprunt);
                productPriceInput.addEventListener('input', updateCoutEmprunt);

                function updateCoutEmprunt() {
                    const prix = parseFloat(productPriceInput.value);
                    const nombre = parseInt(nombreEmprunteInput.value) || 0;

                    if (!isNaN(prix) && nombre > 0) {
                        const total = prix * nombre;
                        coutEmpruntElement.textContent = `Coût total de l'emprunt: ${total.toLocaleString()} HTG`; // Devise changée
                    } else {
                        coutEmpruntElement.textContent = "Veuillez entrer le prix et le nombre de produits pour voir le montant du prêt.";
                    }
                }

                document.getElementById('newProductForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if(isUploading) return;

                    const form = e.target;
                    const formData = {
                        name: form.productName.value.trim(),
                        price: form.productPrice.value,
                        description: form.productDescription.value.trim(),
                        region: form.productRegion.value.trim(),
                        quantity: empruntCheckbox.checked ? nombreEmprunteInput.value : form.productQuantity.value,
                        whatsapp: form.whatsappNumber.value.replace(/\D/g, ''),
                        imageUrl: uploadedFileUrl
                    };

                    // Validation
                    const errors = [];
                    if(!formData.name) errors.push('Nom requis');
                    if(!formData.price || isNaN(formData.price)) errors.push('Prix invalide');
                    if(!formData.description) errors.push('Description requise');
                    if(!formData.region) errors.push('Région requise');
                    if (empruntCheckbox.checked) {
                        if(!nombreEmprunteInput.value || isNaN(nombreEmprunteInput.value)) {
                            errors.push('Nombre à emprunter invalide');
                        }
                    } else {
                        if(!formData.quantity || isNaN(formData.quantity)) {
                            errors.push('Quantité invalide');
                        }
                    }
                    if(!formData.whatsapp || formData.whatsapp.length < 8) errors.push('Numéro WhatsApp invalide');
                    if(!formData.imageUrl) errors.push('Image requise');

                    if(errors.length > 0) {
                        showToast(errors.join(', '));
                        return;
                    }

                    try {
                        isUploading = true;
                        saveButton.disabled = true;
                        saveButton.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i> Enregistrement...';

                        // Création produit
                        const productData = {
                            name: formData.name,
                            price: Number(formData.price),
                            description: formData.description,
                            region: formData.region,
                            quantity: Number(formData.quantity),
                            Nom_vendeur: currentUserName,
                            Num_vendeur: formData.whatsapp,
                            imageUrl: formData.imageUrl,
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        };

                        if (empruntCheckbox.checked) {
                            productData.emprunt = true;
                            productData.nombre_emprunté = Number(nombreEmprunteInput.value);
                            productData.montant_emprunté = Number(nombreEmprunteInput.value) * Number(formData.price);
                            productData.status = 'pending';
                            productData.Quantity_actual = 0; // Produits empruntés n'ont pas de stock initial
                        } else {
                            productData.Quantity_actual = Number(formData.quantity);
                        }

                        // Enregistrement unifié
                        if (empruntCheckbox.checked) {
                            // Sauvegarde dans crédit
                            const newCreditRef = database.ref('crédit').push();
                            await newCreditRef.set(productData);
                        } else {
                            // Sauvegarde dans produits
                            const newProductRef = database.ref('produits').push();
                            await newProductRef.set(productData);
                        }

                        showToast('Produit enregistré avec succès !');
                        resetForm();
                        toggleForm(false);
                        uploadedFileUrl = null;

                    } catch (error) {
                        console.error('Erreur:', error);
                        showToast(`Échec de l'enregistrement: ${error.message}`);
                    } finally {
                        isUploading = false;
                        saveButton.disabled = false;
                        saveButton.innerHTML = saveButtonOriginalHTML; // Restaurer le contenu original
                    }
                });

                // Fonctions helpers
                function toggleForm(show) {
                    productForm.classList.toggle('hidden', !show);
                    addProductBtn.classList.toggle('hidden', show);
                }

                function resetForm() {
                    document.getElementById('newProductForm').reset();
                    document.getElementById('imagePreview').classList.add('hidden');
                    uploadedFileUrl = null;
                    empruntCheckbox.checked = false;
                    empruntFields.classList.add('hidden');
                    quantityField.classList.remove('hidden');
                    quantityInput.setAttribute('required', 'true'); // Réactiver required
                    coutEmpruntElement.textContent = "Veuillez entrer le prix pour voir le montant du prêt.";
                }

                // Chargement produits
                function loadProducts() {
                    // Produits actifs
                    database.ref('produits').on('value', (snapshot) => {
                        currentProducts = [];
                        const products = snapshot.val() || {};
                        const activeProducts = document.getElementById('activeProducts');
                        
                        activeProducts.innerHTML = '';

                        Object.keys(products).forEach(key => {
                            const product = products[key];
                            product.id = key;
                            currentProducts.push(product);

                            if (product.Quantity_actual > 0 && product.Nom_vendeur === currentUserName) {
                                activeProducts.innerHTML += createProductCard(product, false);
                            }
                        });
                    });

                    // Historique
                    database.ref('historique_produits').on('value', (snapshot) => {
                        const history = snapshot.val() || {};
                        const productHistory = document.getElementById('productHistory');
                        productHistory.innerHTML = '';

                        Object.keys(history).forEach(key => {
                            const product = history[key];
                            if (product.Nom_vendeur === currentUserName) {
                                productHistory.innerHTML += createProductCard(product, true);
                            }
                        });
                    });

                    // Produits en attente (crédit)
                    database.ref('crédit').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                        const pendingProducts = document.getElementById('pendingCreditProducts');
                        pendingProducts.innerHTML = '';

                        const credits = snapshot.val() || {};
                        let hasPending = false;

                        Object.keys(credits).forEach(key => {
                            const credit = credits[key];
                            credit.id = key;

                            if (credit.Nom_vendeur === currentUserName) {
                                pendingProducts.innerHTML += createPendingCreditCard(credit);
                                hasPending = true;
                            }
                        });

                        // Afficher ou cacher la section
                        const pendingSection = document.getElementById('pendingCreditSection');
                        if (hasPending) {
                            pendingSection.classList.remove('hidden');
                        } else {
                            pendingSection.classList.add('hidden');
                        }
                    });
                }

                function createProductCard(product, isHistory) {
                    return `
                        <div class="bg-white rounded-lg shadow-sm p-4 product-card">
                            <div class="flex items-center">
                                <img src="${product.imageUrl}" alt="${product.name}" class="w-16 h-16 rounded-lg object-cover object-top">
                                <div class="ml-3 flex-1">
                                    <h3 class="font-medium text-gray-800">${product.name}</h3>
                                    <div class="text-sm text-gray-500">
                                        <p>${Number(product.price).toLocaleString()} HTG</p> <!-- Devise changée -->
                                        <p>Quantité initiale: ${product.quantity}</p>
                                        ${!isHistory ? `<p>Stock actuel: ${product.Quantity_actual}</p>` : ''}
                                        <p>Vendeur: ${product.Nom_vendeur}</p>
                                        <p>Contact: +509 ${product.Num_vendeur}</p>
                                        ${product.emprunt ? `<p class="text-red-600">Montant à payer: ${Number(product.montant_emprunté).toLocaleString()} HTG</p>` : ''} <!-- Devise changée -->
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between mt-3">
                                ${!isHistory ? `
                                    <button data-id="${product.id}" class="reduce-stock-btn text-xs px-3 py-1.5 border border-gray-300 rounded-button cursor-pointer flex items-center">
                                        <div class="w-4 h-4 flex items-center justify-center mr-1">
                                            <i class="ri-subtract-line text-gray-600"></i>
                                        </div>
                                        <span>Vente</span>
                                    </button>
                                    <button data-id="${product.id}" class="cancel-product-btn text-xs px-3 py-1.5 border border-red-100 text-red-600 rounded-button cursor-pointer flex items-center">
                                        <div class="w-4 h-4 flex items-center justify-center mr-1">
                                            <i class="ri-close-line"></i>
                                        </div>
                                        <span>Annuler</span>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }

                function createPendingCreditCard(credit) {
                    return `
                        <div class="bg-white rounded-lg shadow-sm p-4 product-card">
                            <div class="flex items-center">
                                <img src="${credit.imageUrl}" alt="${credit.name}" class="w-16 h-16 rounded-lg object-cover object-top">
                                <div class="ml-3 flex-1">
                                    <h3 class="font-medium text-gray-800">${credit.name}</h3>
                                    <div class="text-sm text-gray-500">
                                        <p>Prix unitaire: ${Number(credit.price).toLocaleString()} HTG</p> <!-- Devise changée -->
                                        <p>Quantité empruntée: ${credit.nombre_emprunté}</p>
                                        <p>Montant total: ${Number(credit.montant_emprunté).toLocaleString()} HTG</p> <!-- Devise changée -->
                                        <p>Vendeur: ${credit.Nom_vendeur}</p>
                                    </div>
                                    <span class="inline-block mt-1 px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">En attente de confirmation</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Gestion interactions
                document.addEventListener('click', async (e) => {
                    if (e.target.closest('.reduce-stock-btn')) {
                        const productId = e.target.closest('button').dataset.id;
                        const product = currentProducts.find(p => p.id === productId);
                        
                        showConfirmModal('Confirmer la vente', `Enregistrer une vente pour "${product.name}" ?`, async () => {
                            try {
                                const newQuantity = product.Quantity_actual - 1;
                                await database.ref(`produits/${productId}/Quantity_actual`).set(newQuantity);
                                
                                if (newQuantity === 0) {
                                    await moveToHistory(productId);
                                }
                                
                                showToast('Vente enregistrée avec succès');
                            } catch (error) {
                                showToast('Erreur lors de la mise à jour du stock');
                            }
                        });
                    }

                    if (e.target.closest('.cancel-product-btn')) {
                        const productId = e.target.closest('button').dataset.id;
                        showConfirmModal('Annuler le produit', 'Êtes-vous sûr de vouloir retirer ce produit du marché ?', async () => {
                            await moveToHistory(productId);
                            showToast('Produit retiré du marché');
                        });
                    }
                });

                async function moveToHistory(productId) {
                    try {
                        const productRef = database.ref(`produits/${productId}`);
                        const productSnapshot = await productRef.once('value');
                        const productData = productSnapshot.val();
                        
                        await database.ref(`historique_produits/${productId}`).set({
                            ...productData,
                            removedAt: firebase.database.ServerValue.TIMESTAMP
                        });
                        await productRef.remove();
                    } catch (error) {
                        console.error(error);
                        showToast('Erreur lors du déplacement du produit');
                    }
                }

                // Initialisation
                loadProducts();
                document.getElementById('toggleHistoryBtn').addEventListener('click', () => {
                    document.getElementById('productHistory').classList.toggle('hidden');
                });
            }

            // Fonctions utilitaires
            window.showToast = (message, duration = 3000) => {
                const toast = document.getElementById('toast');
                toast.querySelector('#toastMessage').textContent = message;
                toast.classList.remove('hidden');
                toast.style.opacity = '1';
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }, duration);
            };

            window.showConfirmModal = (title, message, onConfirm) => {
                const modal = document.getElementById('confirmModal');
                modal.querySelector('#modalTitle').textContent = title;
                modal.querySelector('#modalMessage').textContent = message;
                modal.classList.remove('hidden');

                const confirmHandler = () => {
                    modal.classList.add('hidden');
                    onConfirm();
                    document.getElementById('confirmModalBtn').removeEventListener('click', confirmHandler);
                    document.getElementById('cancelModalBtn').removeEventListener('click', cancelHandler);
                };

                const cancelHandler = () => {
                    modal.classList.add('hidden');
                    document.getElementById('confirmModalBtn').removeEventListener('click', confirmHandler);
                    document.getElementById('cancelModalBtn').removeEventListener('click', cancelHandler);
                };

                document.getElementById('confirmModalBtn').addEventListener('click', confirmHandler);
                document.getElementById('cancelModalBtn').addEventListener('click', cancelHandler);
            };
        });
    </script>
</body>
</html>